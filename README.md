# Laravel TypeScript

Generate TypeScript interfaces from your Eloquent models automatically. Keep your frontend types in sync with your database schema and model definitions.

## Features

- **Automatic type generation** — Scans your models and generates TypeScript interfaces/types
- **Full type resolution** — 8-level precedence chain (overrides → enum casts → PHP casts → DB types → custom mappings)
- **Relation support** — BelongsTo, HasMany, BelongsToMany, Morph relations, with counts, exists, and sums
- **Enum support** — Three output styles: const objects, TypeScript enums, or union types
- **Per-model files** — One file per model with barrel export, or single bundled file
- **Formatter integration** — Auto-format with Prettier or Biome
- **Incremental builds** — Only regenerate changed models
- **Extensible** — Register custom type mappers, introspectors, and writers via facade

## Requirements

- PHP 8.2+
- Laravel 11 or 12

## Installation

```bash
composer require frolax/laravel-typescript --dev
```

Publish the configuration:

```bash
php artisan vendor:publish --tag=typescript-config
```

## Quick Start

Generate TypeScript definitions:

```bash
php artisan typescript:generate
```

Output to stdout:

```bash
php artisan typescript:generate --stdout
```

Generate for a specific model:

```bash
php artisan typescript:generate User
```

## Output Example

Given this Eloquent model:

```php
class User extends Model
{
    protected $fillable = ['name', 'email'];
    protected $hidden = ['password'];
    protected $casts = [
        'email_verified_at' => 'datetime',
        'role' => UserRole::class,
    ];

    public function posts(): HasMany
    {
        return $this->hasMany(Post::class);
    }
}
```

The generated TypeScript:

```typescript
// This file is auto-generated by laravel-typescript.
// Do not edit this file manually.

export interface User {
  // Columns
  id: number;
  name: string;
  email: string;
  email_verified_at: string | null;
  role: UserRole;
  password: string;
  created_at: string | null;
  updated_at: string | null;
  // Relations
  posts: Post[];
  // Counts
  posts_count?: number;
}

export const UserRole = {
  Admin: 'admin',
  User: 'user',
} as const;
export type UserRole = typeof UserRole[keyof typeof UserRole];
```

## CLI Commands

### `typescript:generate`

Generate TypeScript definitions from Eloquent models.

```bash
php artisan typescript:generate [model] [options]
```

| Option | Description |
|--------|-------------|
| `model` | Generate for a specific model only |
| `--output=PATH` | Output path (overrides config) |
| `--writer=TYPE` | Writer: `interface`, `type`, or `json` |
| `--enum-style=STYLE` | Enum style: `const_object`, `ts_enum`, `union` |
| `--global` | Wrap in `declare namespace` |
| `--plurals` | Pluralize type names (`User` → `Users`) |
| `--fillables` | Generate fillable-only types |
| `--no-relations` | Exclude relations |
| `--no-counts` | Exclude relation counts |
| `--timestamps-as-date` | Map timestamps to `Date` instead of `string` |
| `--optional-nullables` | Make nullable columns optional (`name?: type`) |
| `--connection=NAME` | Database connection to use |
| `--strict` | Bail on first model error |
| `--stdout` | Output to stdout only |

### `typescript:inspect`

Inspect a model's metadata:

```bash
php artisan typescript:inspect "App\Models\User"
php artisan typescript:inspect "App\Models\User" --json
```

### `typescript:mappings`

Show current type mappings:

```bash
php artisan typescript:mappings
```

## Configuration

All options are documented in `config/typescript.php`. Key sections:

### Discovery

```php
'discovery' => [
    'paths' => [app_path('Models')],
    'excluded_models' => ['BaseModel'],
],
```

### Output

```php
'output' => [
    'path' => resource_path('types/generated'),
    'per_model_files' => true,       // One file per model
    'barrel_export' => true,         // Generate index.ts
    'enum_directory' => 'enums',     // Subdirectory for enums
],
```

### Writer

```php
'writer' => [
    'default' => 'interface',        // 'interface', 'type', or 'json'
    'enum_style' => 'const_object',  // 'const_object', 'ts_enum', 'union'
    'global_namespace' => null,      // Wrap in declare namespace
    'fillable_types' => false,       // Generate UserFillable types
],
```

### Relations

```php
'relations' => [
    'enabled' => true,
    'optional' => false,             // Make all relations optional
    'counts' => ['enabled' => true, 'optional' => true],
    'exists' => ['enabled' => true, 'optional' => true],
],
```

### Custom Type Mappings

```php
'mappings' => [
    'custom' => [
        'point' => '{ lat: number; lng: number }',
        'money' => 'string',
    ],
    'timestamps_as_date' => false,
],
```

### Naming Convention

```php
'case' => [
    'columns' => 'camel',    // 'snake', 'camel', 'pascal'
    'relations' => 'camel',
],
```

### Formatter

```php
'formatter' => [
    'enabled' => true,
    'tool' => 'prettier',    // 'prettier' or 'biome'
],
```

### Incremental Builds

```php
'cache' => [
    'enabled' => true,       // Skip unchanged models
],
```

## Extension API

Use the `Typescript` facade to extend the package:

### Custom Type Mappers

```php
use Frolax\Typescript\Facades\Typescript;

Typescript::extend(function ($registry) {
    $registry->registerMapper(new class implements TypeMapperContract {
        public function supports(string $type): bool
        {
            return $type === 'point';
        }

        public function resolve(string $type): string
        {
            return '{ lat: number; lng: number }';
        }
    });
});
```

### Forced Type Overrides

Use the `$interfaces` property on your model:

```php
class User extends Model
{
    public array $interfaces = [
        'metadata' => 'Record<string, unknown>',
        'settings' => 'UserSettings',
    ];
}
```

## Architecture

The package uses a pipeline architecture:

```
Discovery → Introspection → Metadata → Type Resolution → Relation Resolution → Writing → Formatting
```

Each stage has a clear contract and can be replaced or extended:

| Module | Contract | Default |
|--------|----------|---------|
| Discovery | `ModelDiscoveryContract` | `ModelDiscovery` |
| Introspection | `SchemaIntrospectorContract` | `LaravelSchemaIntrospector` |
| Metadata | `ModelMetadataExtractorContract` | `ModelMetadataExtractor` |
| Type Resolution | `TypeResolverContract` | `TypeResolver` |
| Relations | `RelationResolverContract` | `RelationResolver` |
| Writing | `WriterContract` | `TypescriptWriter` |
| Formatting | `FormatterContract` | `NullFormatter` |

### Type Resolution Precedence

Types are resolved using an 8-level precedence chain:

1. **Forced override** — `$interfaces` property on model
2. **API resource type** — When `api_resources` mode is enabled
3. **Enum cast** — `AsEnumCollection`, `AsEnumArrayObject`
4. **Accessor return type** — PHP return type from accessor method
5. **Cast type** — Eloquent `$casts` property
6. **DB column type** — Raw database schema type
7. **Custom user mapping** — From `config('typescript.mappings.custom')`
8. **Fallback** — `unknown`

## Testing

```bash
composer test
```

The test suite includes 124+ tests covering:
- Unit tests for all components (mappers, resolvers, writers, cache)
- Integration tests (schema introspection, metadata extraction)
- E2E pipeline tests (full generation flow)
- Artisan command tests

## License

MIT
